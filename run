#! /bin/bash -e

. config || {
    cat << EOF
There's no config file in the current directory.
Please create it (see config.sample in the flashopt root directory).

EOF
    exit 1
}

cleanup()
{
    umount "${mount_dir}"
}

get_result_name()
{
    fs_name=`dirname "${fs}"`
	iosched_name=`basename "${iosched}"`
	benchmark_name=`basename "${benchmark}"`
    result=`readlink -m "${result_dir:-result}/${fs_name}/${iosched_name}-${benchmark_name}"`
}

run_single()
{
    trap cleanup EXIT

    get_result_name
    [ -f "${result}" ] && return

    "${fs}" prepare
    "${iosched}" prepare
    mkdir -p `dirname "${result}"`
    echo 3 > /proc/sys/vm/drop_caches || :
    time { "${benchmark}" run | tee "${result}" ; }
    "${fs}" cleanup
}

run()
{

    for fs in fs/*/* ; do
        [ -x "${fs}" ] || continue
        echo ${fs}

        for iosched in iosched/* ; do
            [ -x "${iosched}" ] && "${iosched}" use || continue
            echo ${iosched}

            for benchmark in benchmark/* ; do
                [ -x "${benchmark}" ] && "${benchmark}" use || continue
                echo ${benchmark}

                run_single
            done
        done
    done
}

print_help()
{
    cat << EOF
Usage: run [analyze|gdiff|geometry|help]

        run:            run benchmarks
        run analyze {throughput|latency}:
                        suggest FS options/IO schedulers based on measured
                        performance data to optimize throughput or latency
        run gdiff:      plot performance data grouped by benchmark
        run geometry:   run flashbench and suggest medium geometry parameters
        run help:       this help
EOF
}

case "$1" in
    "")
        run
        ;;

    run_single)
        run_single
        ;;

    *)
        print_help
        ;;

esac
